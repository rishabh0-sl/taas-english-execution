# TaaS LLM Backend Server

A high-performance **Python FastAPI** backend server that generates and executes test scenarios using **real Gemini API** and **Playwright MCP server** with comprehensive reporting and screenshot proofs.

## Features

- **ü§ñ Real Gemini API Integration**: Uses actual Google Gemini API for intelligent test scenario generation
- **üé≠ Playwright MCP Execution**: Executes LLM-generated JSON scenarios with real browser automation
- **üì∏ Screenshot Proof**: Automatically captures screenshots at each step for visual verification
- **üìä Comprehensive Reports**: Generates detailed execution reports with artifacts and traces
- **üìù Single Scenario Generation**: Creates exactly 1 focused, actionable test scenario per request
- **üîí Security-Aware**: Skips validation on sensitive domains (auth, banking, government sites)
- **üìä Results Management**: Organized storage and retrieval of test results and artifacts
- **üöÄ High Performance**: Built with FastAPI for maximum speed and async capabilities
- **üêç Python Native**: Pure Python implementation with modern async/await patterns

## Prerequisites

- **üêç Python 3.8 or higher**
- **üì¶ pip** (Python package manager)
- **üé≠ Playwright browsers** (automatically installed)
- **üîë Gemini API Key** (from Google AI Studio)

## Quick Start

### 1. **Install Dependencies**
```bash
# Install Python packages
pip install -r requirements.txt

# Install Playwright browsers for automation
playwright install
```

### 2. **Configure Environment**
Update your `.env` file with your actual Gemini API key:
```env
GEMINI_API_KEY=your_actual_gemini_api_key_here
```

### 3. **Start the Server**
```bash
python main.py
```

### 4. **Verify Installation**
```bash
curl http://localhost:3000/health
```

**Expected Response:**
```json
{
  "status": "healthy",
  "timestamp": "2025-09-06T17:35:34.285746",
  "service": "TaaS LLM Backend",
  "version": "1.0.0"
}
```

## How to Run and Test

### **1. Start the Server**
```bash
python main.py
```

**Server will start at `http://localhost:3000`** üöÄ

### **2. Test with Your English Test Case**
```bash
curl -X POST http://localhost:3000/api/v1/generate \
  -H "Content-Type: application/json" \
  -d '{
    "objective": "Go to google, search for python tutorials, click on first result"
  }'
```

### **3. What You Get**
- **ü§ñ 1 Single Scenario** generated by real Gemini API
- **üé≠ Real Playwright Execution** of the scenario with browser automation
- **üì∏ Screenshot Proof** at each step (initial, during execution, final)
- **üìä Comprehensive Reports** with execution metrics and artifacts
- **üîç Playwright Traces** for debugging and analysis

### **4. View Results**
- **Generated Scenarios**: `results/` folder
- **MCP Validation**: `result-mcp/` folder
- **Playwright Reports**: `playwright-reports/` folder

### **5. Test Examples**

#### **üéØ Amazon Add to Cart Test (with Screenshot Proof)**
```bash
curl -X POST http://localhost:3000/api/v1/generate \
  -H "Content-Type: application/json" \
  -d '{
    "objective": "Go to Amazon, search for wireless headphones, click on the first product result, then add it to cart. Take screenshots at each step to prove it worked."
  }'
```

#### **üîç Other Test Examples**
```bash
# Simple navigation test
curl -X POST http://localhost:3000/api/v1/generate \
  -H "Content-Type: application/json" \
  -d '{"objective": "Go to google and search for javascript"}'

# E-commerce test
curl -X POST http://localhost:3000/api/v1/generate \
  -H "Content-Type: application/json" \
  -d '{"objective": "Go to amazon, search for laptop, add first result to cart"}'

# Form test
curl -X POST http://localhost:3000/api/v1/generate \
  -H "Content-Type: application/json" \
  -d '{"objective": "Go to example.com, fill contact form with name and email, submit"}'
```

## API Endpoints

### Health Check
```http
GET /health
```
Returns server status and configuration.

### Generate and Execute Test Scenarios
```http
POST /api/v1/generate
Content-Type: application/json

{
  "objective": "Go to google, search for python tutorials, click first result"
}
```

**Response:**
```json
{
  "success": true,
  "scenarios": [
    {
      "name": "Search Python Tutorials on Google",
      "description": "Navigate to Google, search for python tutorials, and click the first result",
      "steps": [
        {"action": "goto", "url": "https://google.com"},
        {"action": "fill", "selector": "textarea", "value": "python tutorials"},
        {"action": "click", "selector": "[role=\"button\"]"},
        {"action": "click", "selector": "a[data-ved]"}
      ]
    }
  ],
  "validation": {
    "passed": true,
    "errors": []
  },
  "mcpValidation": {
    "enabled": true,
    "validated": true,
    "executionReport": {
      "status": "completed",
      "totalExecutionTime": "3247ms",
      "databaseUpdates": [
        {"operation": "Store execution time", "status": "completed"},
        {"operation": "Update scenario metrics", "status": "completed"}
      ],
      "authoring": [
        {"operation": "Update authoring databases with metrics", "method": "DAL helpers"}
      ]
    }
  },
  "playwrightExecution": {
    "enabled": true,
    "execution": {
      "status": "passed",
      "executionTime": "5432ms"
    },
    "files": {
      "htmlReport": "/playwright-reports/report-2025-09-06T09-17-14-163/html-report",
      "testFile": "/playwright-reports/report-2025-09-06T09-17-14-163/test.spec.js"
    }
  }
}
```

### Compile Scenarios to Playwright Tests
```http
POST /api/v1/compile
Content-Type: application/json

{
  "scenarios": [...],
  "testName": "My Custom Test",
  "generatePageObjects": true
}
```

### Execute Scenario with Playwright
```http
POST /api/v1/execute
Content-Type: application/json

{
  "scenario": {
    "name": "Test Name",
    "description": "Test description",
    "steps": [
      {"action": "goto", "url": "https://example.com"},
      {"action": "fill", "selector": "input[name='search']", "value": "test"},
      {"action": "click", "selector": "button[type='submit']"}
    ]
  },
  "testName": "Custom Test Name"
}
```

### List Results and Reports
```http
GET /api/v1/results          # List all generated scenarios
GET /api/v1/results-mcp      # List MCP-validated scenarios
GET /api/v1/reports          # List Playwright execution reports
```

## Configuration

All configuration is managed through `.env`:

```env
# Required - Get from Google AI Studio
GEMINI_API_KEY=your_actual_gemini_api_key_here

# Server Configuration
PORT=3000
HOST=localhost

# MCP Validation Settings
ENABLE_MCP_VALIDATION=true

# Directory Configuration
RESULTS_DIR=results
MCP_RESULTS_DIR=result-mcp

# Security - Skip MCP validation on sensitive domains
SKIP_MCP_DOMAINS=auth,login,signin,signup,admin,.gov,.mil,banking,payment
```

## Scenario Structure

Test scenarios follow this structure:

```json
{
  "name": "Login Test",
  "description": "Test user authentication flow",
  "steps": [
    {
      "action": "goto",
      "url": "https://example.com/login"
    },
    {
      "action": "fill",
      "selector": "input[name='username']",
      "value": "testuser@example.com"
    },
    {
      "action": "click",
      "selector": "button[type='submit']"
    },
    {
      "action": "expect",
      "selector": "body",
      "condition": "not.toContainText",
      "value": "Invalid"
    }
  ]
}
```

### Supported Actions

- **`goto`**: Navigate to a URL
  - Required: `url`
  
- **`fill`**: Fill form inputs
  - Required: `selector`, `value`
  
- **`click`**: Click elements
  - Required: `selector`
  
- **`expect`**: Assert conditions
  - Required: `selector`, `condition`
  - Optional: `value`

### Supported Expect Conditions

- `toBeVisible`: Element is visible
- `toContainText`: Element contains specific text
- `not.toContainText`: Element does not contain specific text

## MCP Validation

The MCP (Model Context Protocol) validation service uses Playwright to:

1. **Navigate to target pages**
2. **Validate selectors** exist and are interactable
3. **Generate alternative selectors** when original ones fail
4. **Skip sensitive domains** automatically

### Sensitive Domain Protection

MCP validation is automatically skipped for URLs containing:
- `auth`, `login`, `signin`, `signup`
- `admin`, `.gov`, `.mil`
- `banking`, `payment`

## File Structure

```
taas_llm/
‚îú‚îÄ‚îÄ config.env              # Environment configuration
‚îú‚îÄ‚îÄ package.json            # Dependencies and scripts
‚îú‚îÄ‚îÄ server.js               # Main server file
‚îú‚îÄ‚îÄ results/                # Generated scenarios and tests
‚îÇ   ‚îú‚îÄ‚îÄ scenario-*.json     # Raw scenarios
‚îÇ   ‚îú‚îÄ‚îÄ compiled-test-*.js  # Generated Playwright tests
‚îÇ   ‚îî‚îÄ‚îÄ page-objects/       # Generated page object files
‚îî‚îÄ‚îÄ result-mcp/             # MCP-validated results
    ‚îî‚îÄ‚îÄ mcp-validated-*.json
```

## Error Handling

The server implements comprehensive error handling:

- **Validation Errors**: Invalid scenarios are logged with specific error messages
- **MCP Failures**: Selector validation failures are captured and alternatives suggested
- **API Errors**: All endpoint errors are logged and saved to results directory
- **Graceful Degradation**: Server continues operating even if MCP validation fails

## Development

### Running in Development Mode
```bash
npm run dev
```

### Testing the API

**Generate scenarios:**
```bash
curl -X POST http://localhost:3000/api/v1/generate \
  -H "Content-Type: application/json" \
  -d '{
    "objective": "Test search functionality",
    "targetUrl": "https://example.com"
  }'
```

**Compile scenarios:**
```bash
curl -X POST http://localhost:3000/api/v1/compile \
  -H "Content-Type: application/json" \
  -d '{
    "scenarios": [...],
    "testName": "Search Test",
    "generatePageObjects": true
  }'
```

## üì∏ Generated Artifacts & Screenshots

Each test execution generates comprehensive artifacts for proof and debugging:

### **Report Structure:**
```
playwright-reports/report-[timestamp]/
‚îú‚îÄ‚îÄ üìÑ execution-result.txt          # üìã Formatted test results
‚îú‚îÄ‚îÄ üìÑ execution-report.json         # üìä Detailed execution data
‚îî‚îÄ‚îÄ üìÅ artifacts/
    ‚îú‚îÄ‚îÄ üñºÔ∏è screenshot-001.png       # Initial page state
    ‚îú‚îÄ‚îÄ üñºÔ∏è screenshot-final.png     # Final result
    ‚îî‚îÄ‚îÄ üîç trace-001.zip           # Playwright trace for debugging
```

### **Screenshot Proof:**
- **üì∏ Initial Screenshot**: Captured before any actions
- **üì∏ Step-by-Step**: Screenshots during execution (when applicable)
- **üì∏ Final Screenshot**: Shows the end result of the test
- **üîç Playwright Traces**: Complete browser session recording

### **Formatted Results:**
Each execution generates a formatted result like:
```
### Result
True

### Ran Playwright code
await page.goto('https://amazon.com');
await page.locator('#search-input').fill('wireless headphones');
await page.locator('[type="submit"]').click();
await page.locator('.product-link').first.click();
await page.locator('#add-to-cart').click();

### Page state
URL: https://www.amazon.com/cart
Title: Amazon.com Shopping Cart
Snapshot: Cart page loaded successfully

### Artifacts
screenshot: playwright-reports/report-.../artifacts/screenshot-001.png
trace: playwright-reports/report-.../artifacts/trace-001.zip
screenshot_final: playwright-reports/report-.../artifacts/screenshot-final.png
```

## Troubleshooting

### Common Issues

1. **Server won't start**
   - Check that `GEMINI_API_KEY` is set in `.env`
   - Ensure Python virtual environment is activated: `source venv/bin/activate`
   - Verify port 3000 is not in use: `lsof -i :3000`

2. **MCP validation failing**
   - Check if Playwright browsers are installed: `playwright install`
   - Verify target URLs are accessible
   - Check if domain is in `SKIP_MCP_DOMAINS` list

3. **Scenarios not generating**
   - Check server logs for Gemini API errors
   - Verify `.env` file exists with valid `GEMINI_API_KEY`
   - Ensure internet connection for Gemini API calls

4. **Screenshots not generating**
   - Verify Playwright browsers are properly installed
   - Check write permissions for `playwright-reports/` directory

### Logs

Server logs include:
- ‚úÖ Startup configuration and environment validation
- ü§ñ Gemini API requests and responses
- üé≠ MCP validation progress and selector testing
- üì∏ Screenshot capture confirmations
- ‚ùå Error details with full stack traces

## Security Considerations

- **üîë API Key Protection**: Keep `GEMINI_API_KEY` secure and never commit to version control
- **üåê Domain Filtering**: Sensitive domains automatically excluded from MCP validation
- **‚úÖ Input Validation**: All API inputs validated before processing
- **üñºÔ∏è Screenshot Security**: Screenshots may contain sensitive data - review before sharing
- **Error Sanitization**: Error responses don't expose sensitive internal details

## Performance Notes

- **üöÄ FastAPI Async**: Built with FastAPI for high-performance async operations
- **üé≠ Headless Browsing**: Playwright runs in headless mode for better performance
- **üîÑ Parallel Processing**: MCP validation processes scenarios concurrently
- **üßπ Resource Cleanup**: Browser instances properly closed after validation
- **üìÅ File Management**: Results organized by timestamp to prevent conflicts
- **‚ö° Gemini API**: Direct integration with Google's fast Gemini API

## License

MIT License - Pure Python implementation.

## Support

For issues and questions:
1. **üìã Check server logs** for detailed error information
2. **‚öôÔ∏è Verify configuration** in `.env` file
3. **üß™ Test with simple scenarios** first (like Google search)
4. **üåê Check network connectivity** for Gemini API and MCP validation
5. **üì∏ Review screenshots** in `playwright-reports/` for visual debugging

## üéØ Amazon Test Case Example

**Ready-to-run Amazon add-to-cart test:**

```bash
curl -X POST http://localhost:3000/api/v1/generate \
  -H "Content-Type: application/json" \
  -d '{
    "objective": "Go to Amazon, search for wireless headphones, click on the first product result, then add it to cart. Take screenshots at each step to prove it worked."
  }'
```

**This will generate:**
- ‚úÖ Complete e-commerce workflow test
- üì∏ Screenshots proving each step worked
- üìä Detailed execution metrics
- üîç Playwright traces for debugging
- üìã Formatted results with visual proof
